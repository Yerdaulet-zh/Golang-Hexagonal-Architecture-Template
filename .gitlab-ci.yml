---
stages:
  - lint
  - validate
  - test

variables:
  GOLANGCI_LINT_VERSION: "v1.64.0"

cache:
  paths:
    - .cache/go-build
    - .cache/golangci-lint

lint:
  stage: lint
  image: golangci/golangci-lint:${GOLANGCI_LINT_VERSION}-alpine
  script:
    # Run the Go meta-linter
    - golangci-lint run ./...
    
    # Lint YAML/CI files
    - apk add --no-cache yamllint
    - yamllint docker-compose.yml .gitlab-ci.yml

validate-docker:
  stage: validate
  image: docker:24.0.5
  services:
    - docker:24.0.5-dind
  script:
    - docker compose config -q
    - echo "Docker Compose file is valid!"

test-go:
  stage: test
  image: golang:1.26-alpine
  script:
    - go test -v -race -cover ./...
